{% extends 'home.html' %}
{% load static %}
{% block content %}

<h1>
    {{ wishlist.name }}
    {% if is_owner %}
    <button id="wishlistDeleteBtn">Delete</button>
    {% endif %}
</h1>

<!-- –ú–æ–¥–∞–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –í–ï–°–¨–û–ì–û —Å–ø–∏—Å–∫—É -->
<div id="deleteConfirm">
    <p>Are you sure you want to delete this wishlist?</p>
    <div class="buttons">
        <form id="deleteForm" action="{% url 'wishlist:wishlist_delete' wishlist.pk %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="delete-btn">Yes, delete</button>
        </form>
        <button id="cancelDelete" class="cancel-btn" type="button">Cancel</button>
    </div>
</div>

{% if is_owner and wishlist.items.all|length %}
<div class="share-section">
    <p>
        <strong>Share your wishlist:</strong>
        
        <!-- Copy Link -->
        <a href="#" class="copy-link" data-url="{{ request.scheme }}://{{ request.get_host }}{{ wishlist.get_absolute_url }}">
           üîó Copy Link
        </a>
        <span class="copy-msg" style="display:none; color:green; margin-left:10px;">Copied!</span>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <!-- WhatsApp -->
        <a href="https://wa.me/?text=Check%20out%20this%20wishlist%20{{ request.scheme }}://{{ request.get_host }}{{ wishlist.get_absolute_url }}"
          target="_blank" style="font-size:32px; color:#25D366;">
          <i class="fab fa-whatsapp"></i>
        </a>

        <!-- Telegram -->
        <a href="https://t.me/share/url?url={{ request.scheme }}://{{ request.get_host }}{{ wishlist.get_absolute_url }}&text=Check%20out%20this%20wishlist"
          target="_blank" style="font-size:32px; color:#0088cc;">
          <i class="fab fa-telegram"></i>
        </a>

        <!-- Facebook -->
        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.scheme }}://{{ request.get_host }}{{ wishlist.get_absolute_url }}"
          target="_blank" style="font-size:32px; color:#1877F2;">
          <i class="fab fa-facebook"></i>
        </a>
    </p>
</div>
{% endif %}

<!-- –°–ø–∏—Å–æ–∫ –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ -->
<div class="wishlist-container">
    {% if is_owner %}
    <!-- –ö–∞—Ä—Ç–∫–∞ "Add new item" -->
    <div class="wishlist-item add-item">
        <a href="{% url 'wishlist:item_create' wishlist.pk %}" class="add-item-link">
            <div class="add-item-plus">Ôºã</div>
            <div class="add-item-text">Add new item</div>
        </a>
    </div>
    {% endif %}

    {% for item in wishlist.items.all %}
    <div class="wishlist-item">
      {% if is_owner %}
        <!-- –ö–Ω–æ–ø–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç–∞ -->
        <button type="button" class="delete-item-btn" data-url="{% url 'wishlist:item_delete' item.pk %}" aria-label="Delete item">√ó</button>
      {% endif %}
        
        <a href="{% url 'wishlist:item_detail' item.pk %}">
          <img src="{% if item.image %}{{ item.image.url }}{% else %}{% static 'images/default-gift.png' %}{% endif %}"
              alt="{{ item.title }}" class="wishlist-img">
        </a>

        <h3 class="wishlist-title">{{ item.title }}</h3>

        {% if item.price %}
          <p class="wishlist-price">{{ item.price }} –≥—Ä–Ω</p>
        {% endif %}
      </div>
    {% empty %}
      <p>No items yet.</p>
    {% endfor %}
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –û–ö–†–ï–ú–û–ì–û –µ–ª–µ–º–µ–Ω—Ç–∞ -->
<div id="itemDeleteConfirm" class="item-delete-popup">
    <p id="deleteMessage">Are you sure you want to delete this gift?</p>
    <form id="itemDeleteForm" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="delete-btn">Yes, delete</button>
    </form>
    <button id="cancelItemDelete" class="cancel-btn" type="button">Cancel</button>
</div>

<!-- –ù–∞–ø—ñ–≤–ø—Ä–æ–∑–æ—Ä–∏–π —Ñ–æ–Ω –¥–ª—è –æ–±–æ—Ö –º–æ–¥–∞–ª–æ–∫ -->
<div id="overlay" style="display:none;"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // ===== –ö–æ–ø—ñ—é–≤–∞–Ω–Ω—è –ª—ñ–Ω–∫–∞ =====
    document.querySelectorAll(".copy-link").forEach(link => {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            const url = this.dataset.url;
            navigator.clipboard.writeText(url).then(() => {
                const msg = this.nextElementSibling;
                if (msg && msg.classList.contains('copy-msg')) {
                    msg.style.display = "inline";
                    setTimeout(() => (msg.style.display = "none"), 2000);
                }
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Link copied to clipboard!');
            });
        });
    });

    // ===== –ï–ª–µ–º–µ–Ω—Ç–∏ –º–æ–¥–∞–ª–æ–∫ =====
    const overlay            = document.getElementById("overlay");
    const listConfirm        = document.getElementById("deleteConfirm");
    const cancelDelete       = document.getElementById("cancelDelete");
    const wishlistDeleteBtn  = document.getElementById("wishlistDeleteBtn");

    const itemConfirm        = document.getElementById("itemDeleteConfirm");
    const itemDeleteForm     = document.getElementById("itemDeleteForm");
    const deleteMessage      = document.getElementById("deleteMessage");
    const cancelItemDelete   = document.getElementById("cancelItemDelete");

    // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –º–æ–¥–∞–ª–∫–∞–º–∏
    function openModal(modalElement) {
        if (!modalElement || !overlay) return;
        modalElement.style.display = "block";
        overlay.style.display = "block";
        document.body.style.overflow = "hidden"; // –ë–ª–æ–∫—É—î–º–æ —Å–∫—Ä–æ–ª
    }
    
    function closeAllModals() {
        if (listConfirm) listConfirm.style.display = "none";
        if (itemConfirm) itemConfirm.style.display = "none";
        if (overlay) overlay.style.display = "none";
        document.body.style.overflow = ""; // –í—ñ–¥–Ω–æ–≤–ª—é—î–º–æ —Å–∫—Ä–æ–ª
    }

    // ===== –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª–∫—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É =====
    if (wishlistDeleteBtn && listConfirm && overlay) {
        wishlistDeleteBtn.addEventListener("click", function() {
            openModal(listConfirm);
        });
    }
    
    if (cancelDelete) {
        cancelDelete.addEventListener("click", closeAllModals);
    }

    // ===== –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª–∫—É –≤–∏–¥–∞–ª–µ–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç–∞ =====
    function attachDeleteButtons() {
        document.querySelectorAll(".delete-item-btn").forEach(btn => {
            btn.addEventListener("click", function() {
                console.log("Delete button clicked"); // –î–ª—è –≤—ñ–¥–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
                
                if (!itemConfirm || !itemDeleteForm) {
                    console.log("Modal elements not found");
                    return;
                }
                
                const url = this.dataset.url;
                const wishlistItem = this.closest(".wishlist-item");
                const titleElement = wishlistItem?.querySelector(".wishlist-title");
                const giftTitle = titleElement?.textContent?.trim() || "this gift";

                console.log("Delete URL:", url); // –î–ª—è –≤—ñ–¥–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
                console.log("Gift title:", giftTitle); // –î–ª—è –≤—ñ–¥–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è

                // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ URL –¥–ª—è —Ñ–æ—Ä–º–∏
                itemDeleteForm.setAttribute("action", url);
                
                // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                if (deleteMessage) {
                    deleteMessage.textContent = `Are you sure you want to delete "${giftTitle}"?`;
                }
                
                openModal(itemConfirm);
            });
        });
    }

    // –í–∏–∫–ª–∏–∫–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –ø—Ä–∏–≤'—è–∑–∫–∏ –∫–Ω–æ–ø–æ–∫
    attachDeleteButtons();

    // ===== –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–æ–∫ =====
    if (cancelItemDelete) {
        cancelItemDelete.addEventListener("click", closeAllModals);
    }
    
    if (overlay) {
        overlay.addEventListener("click", closeAllModals);
    }

    // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–æ–∫ –ø–æ Escape
    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape") {
            closeAllModals();
        }
    });

    // –ó–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –∑–∞–∫—Ä–∏—Ç—Ç—é –ø—Ä–∏ –∫–ª—ñ–∫—É –Ω–∞ —Å–∞–º—É –º–æ–¥–∞–ª–∫—É
    if (listConfirm) {
        listConfirm.addEventListener("click", function(e) {
            e.stopPropagation();
        });
    }
    
    if (itemConfirm) {
        itemConfirm.addEventListener("click", function(e) {
            e.stopPropagation();
        });
    }
});
</script>
{% endblock %}