{% extends 'home.html' %}
{% load static %}
{% block content %}

<h1>
    <span id="wishlist-name-display">{{ wishlist.name }}</span>
    {% if is_owner %}
    <button id="edit-wishlist-btn" style="margin-left:8px; cursor:pointer;">‚úèÔ∏è</button>
    <button id="wishlistDeleteBtn">Delete</button>
    {% endif %}
</h1>

<form id="wishlist-name-form" action="{% url 'wishlist:wishlist_edit_name' wishlist.pk %}" method="post" style="display:none;">
    {% csrf_token %}
    <input type="text" name="name" id="wishlist-name-input" value="{{ wishlist.name }}" style="font-size:32px;">
    <button type="submit" class="btn-save">Save</button>
    <button type="button" class="btn-cancel" id="cancel-edit-btn">Cancel</button>
</form>

<p>
  <a href="{% url 'wishlist:wishlist_list' %}" class="btn-back">Back to all wishlists</a>
</p>
<!-- Delete ENTIRE list modal -->
<div id="deleteConfirm">
    <p>Are you sure you want to delete this wishlist?</p>
    <div class="buttons">
        <form id="deleteForm" action="{% url 'wishlist:wishlist_delete' wishlist.pk %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="delete-btn">Yes, delete</button>
        </form>
        <button id="cancelDelete" class="cancel-btn" type="button">Cancel</button>
    </div>
</div>

{% if is_owner and wishlist.items.all|length %}
<div class="share-section">
    <p>
        <strong>Share your wishlist:</strong> 
        <!-- Copy Link -->
        <a href="#" class="copy-link" data-url="{{ request.scheme }}://{{ request.get_host }}{{ wishlist.get_absolute_url }}">
           üîó Copy Link
        </a>
        <span class="copy-msg" style="display:none; color:green; margin-left:10px;">Copied!</span>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

        <!-- WhatsApp -->
        <a href="https://wa.me/?text=Check%20out%20this%20wishlist%20{{ request.scheme }}://{{ request.get_host }}{{ wishlist.get_absolute_url }}"
          target="_blank" style="font-size:32px; color:#25D366;">
          <i class="fab fa-whatsapp"></i>
        </a>

        <!-- Telegram -->
        <a href="https://t.me/share/url?url={{ request.scheme }}://{{ request.get_host }}{{ wishlist.get_absolute_url }}&text=Check%20out%20this%20wishlist"
          target="_blank" style="font-size:32px; color:#0088cc;">
          <i class="fab fa-telegram"></i>
        </a>

        <!-- Facebook -->
        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.scheme }}://{{ request.get_host }}{{ wishlist.get_absolute_url }}"
          target="_blank" style="font-size:32px; color:#1877F2;">
          <i class="fab fa-facebook"></i>
        </a>
    </p>
</div>
{% endif %}
<!-- List of elements -->
<div class="wishlist-container">
    {% if is_owner %}
    <!-- Card "Add new item" -->
    <div class="wishlist-item add-item">
        <a href="{% url 'wishlist:item_create' wishlist.pk %}" class="add-item-link">
            <div class="add-item-plus">Ôºã</div>
            <div class="add-item-text">Add new item</div>
        </a>
    </div>
    {% endif %}

    {% for item in wishlist.items.all %}
    <div class="wishlist-item">
      {% if is_owner %}
        <!-- Delete item button -->
        <button type="button" class="delete-item-btn" data-url="{% url 'wishlist:item_delete' item.pk %}" aria-label="Delete item">√ó</button>
      {% endif %}
        
        <a href="{% url 'wishlist:item_detail' item.pk %}">
          <img src="{% if item.image %}{{ item.image.url }}{% else %}{% static 'images/default-gift.png' %}{% endif %}"
              alt="{{ item.title }}" class="wishlist-img">
        </a>

        <h3 class="wishlist-title">{{ item.title }}</h3>

        {% if item.price %}
          <p class="wishlist-price">{{ item.price }} –≥—Ä–Ω</p>
        {% endif %}
      </div>
    {% empty %}
      <p>No items yet.</p>
    {% endfor %}
</div>

<!-- Modal for deleting a SINGLE element -->
<div id="itemDeleteConfirm" class="item-delete-popup">
    <p id="deleteMessage">Are you sure you want to delete this gift?</p>
    <form id="itemDeleteForm" method="post" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="delete-btn">Yes, delete</button>
    </form>
    <button id="cancelItemDelete" class="cancel-btn" type="button">Cancel</button>
</div>

<!-- Semi-transparent background for both modals -->
<div id="overlay" style="display:none;"></div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const editBtn = document.getElementById('edit-wishlist-btn');
    const cancelBtn = document.getElementById('cancel-edit-btn');
    const display = document.getElementById('wishlist-name-display');
    const form = document.getElementById('wishlist-name-form');

    if(editBtn) {
        editBtn.addEventListener('click', () => {
        display.style.display = 'none'; // —Ç–µ–ø–µ—Ä display —ñ—Å–Ω—É—î
        form.style.display = 'block';
    });
    }

    if(cancelBtn) {
        cancelBtn.addEventListener('click', () => {
            form.style.display = 'none';
            display.style.display = 'block';
        });
    }
    // ===== Copy link =====
    document.querySelectorAll(".copy-link").forEach(link => {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            const url = this.dataset.url;
            navigator.clipboard.writeText(url).then(() => {
                const msg = this.nextElementSibling;
                if (msg && msg.classList.contains('copy-msg')) {
                    msg.style.display = "inline";
                    setTimeout(() => (msg.style.display = "none"), 2000);
                }
            }).catch(err => {
                console.error('Failed to copy: ', err);
                alert('Link copied to clipboard!');
            });
        });
    });

    // ===== Elements of modals =====
    const overlay            = document.getElementById("overlay");
    const listConfirm        = document.getElementById("deleteConfirm");
    const cancelDelete       = document.getElementById("cancelDelete");
    const wishlistDeleteBtn  = document.getElementById("wishlistDeleteBtn");

    const itemConfirm        = document.getElementById("itemDeleteConfirm");
    const itemDeleteForm     = document.getElementById("itemDeleteForm");
    const deleteMessage      = document.getElementById("deleteMessage");
    const cancelItemDelete   = document.getElementById("cancelItemDelete");

    // Functions for working with modals
    function openModal(modalElement) {
        if (!modalElement || !overlay) return;
        modalElement.style.display = "block";
        overlay.style.display = "block";
        document.body.style.overflow = "hidden"; 
    }
    
    function closeAllModals() {
        if (listConfirm) listConfirm.style.display = "none";
        if (itemConfirm) itemConfirm.style.display = "none";
        if (overlay) overlay.style.display = "none";
        document.body.style.overflow = "";
    }

    // ===== Open the delete list modal =====
    if (wishlistDeleteBtn && listConfirm && overlay) {
        wishlistDeleteBtn.addEventListener("click", function() {
            openModal(listConfirm);
        });
    }
    
    if (cancelDelete) {
        cancelDelete.addEventListener("click", closeAllModals);
    }

    // ===== Open the delete item modal =====
    function attachDeleteButtons() {
        document.querySelectorAll(".delete-item-btn").forEach(btn => {
            btn.addEventListener("click", function() {

                
                if (!itemConfirm || !itemDeleteForm) {
                    console.log("Modal elements not found");
                    return;
                }
                
                const url = this.dataset.url;
                const wishlistItem = this.closest(".wishlist-item");
                const titleElement = wishlistItem?.querySelector(".wishlist-title");
                const giftTitle = titleElement?.textContent?.trim() || "this gift";

                // Setting the URL for the form
                itemDeleteForm.setAttribute("action", url);
                
                // Updating the message text
                if (deleteMessage) {
                    deleteMessage.textContent = `Are you sure you want to delete "${giftTitle}"?`;
                }
                
                openModal(itemConfirm);
            });
        });
    }

    // Calling the button binding function
    attachDeleteButtons();

    // ===== Closing modals =====
    if (cancelItemDelete) {
        cancelItemDelete.addEventListener("click", closeAllModals);
    }
    
    if (overlay) {
        overlay.addEventListener("click", closeAllModals);
    }

    // Closing modals by Escape
    document.addEventListener("keydown", function(e) {
        if (e.key === "Escape") {
            closeAllModals();
        }
    });

    // Preventing closing when clicking on the modal itself
    if (listConfirm) {
        listConfirm.addEventListener("click", function(e) {
            e.stopPropagation();
        });
    }
    
    if (itemConfirm) {
        itemConfirm.addEventListener("click", function(e) {
            e.stopPropagation();
        });
    }
});
</script>
{% endblock %}